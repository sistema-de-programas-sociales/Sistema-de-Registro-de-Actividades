<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de seguimiento de actividades - CEySIE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="bg-gray-50">
    <!-- CONFIGURACI√ìN -->
    <script>
        const GOOGLE_CLIENT_ID = '649876702440-l91gfiqiu47n8u7o3sip8vpr99ivqdbg.apps.googleusercontent.com';
        const GOOGLE_DRIVE_FOLDER_ID = '1u31rHppvtVhC7BAl2ZTYXUUxZt_Xt_lb';
    </script>

    <!-- Pantalla de inicio de sesi√≥n -->
    <div id="loginScreen" class="fixed inset-0 bg-gradient-to-br from-blue-900 via-blue-800 to-blue-900 flex items-center justify-center z-50">
        <div class="max-w-md w-full mx-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Sistema de Seguimiento</h1>
                    <p class="text-gray-600">SDHyBC - Secretar√≠a de Desarrollo Humano y Bien Com√∫n</p>
                </div>

                <div id="stepSelectUser" class="space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Selecciona tu usuario</h2>
                    <div id="userList" class="space-y-2">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>

                <div id="stepConnectGoogle" class="hidden">
                    <div class="text-center space-y-4">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto">
                            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-800">Hola, <span id="selectedUserName" class="text-blue-600"></span></h2>
                        <p class="text-gray-600 text-sm">Ahora conecta tu cuenta de Google para continuar</p>
                        <button id="connectGoogleBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Conectar con Google
                        </button>
                        <button onclick="window.backToUserSelection()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-6 rounded-lg transition duration-200">
                            ‚Üê Cambiar usuario
                        </button>
                    </div>
                </div>

                <div id="stepLoading" class="hidden">
                    <div class="text-center space-y-4">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                        <p class="text-gray-600">Conectando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla principal del sistema -->
    <div id="app" class="hidden"></div>

    <script type="module">
        console.log('üîµ Iniciando script...');
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyA-wYzNg1Gh1Hp5ctHlAHbnu7IhnVIb0og",
            authDomain: "sdhybc-9dc43.firebaseapp.com",
            projectId: "sdhybc-9dc43",
            storageBucket: "sdhybc-9dc43.appspot.com",
            messagingSenderId: "953815565213",
            appId: "1:953815565213:web:0cb8995235b5cc6e0aa574"
        };

        let app, db;
        let accessToken = null;
        let isGoogleDriveReady = false;
        let currentUser = null; // Usuario actual autenticado
        let isAdmin = false; // Control de permisos administrativos
        let userEmail = ''; // Email del usuario autenticado
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log('‚úÖ Firebase inicializado');
        } catch (error) {
            console.error('‚ùå Error Firebase:', error);
        }
        
        const teamMembers = ['Juan Pablo Salazar', 'Efren Mendoza', 'Laura Nayelly', 'Donaji Buenrostro', 'Marco Carrasco'];

        let activities = [];
        let showForm = false, showModal = false, showDeleteModal = false, showMemberStats = false, showFilesModal = false;
        let currentActivity = null, activityToDelete = null, deletePassword = '';
        let selectedFiles = [], selectedLinks = [], searchTerm = '', filterMember = '', filterStatus = '', filterMonth = '';
        let formData = { creator: '', title: '', description: '', deadline: '', requiresSubmission: false };
        let submissionData = { name: '', comments: '' };
        let openComments = {}; // Rastrear qu√© comentarios est√°n abiertos
        let currentMemberFiles = null; // Guardar los datos del miembro para el modal
        let filesSearchTerm = ''; // B√∫squeda en modal de archivos
        let filesFilterMonth = ''; // Filtro de mes en modal de archivos
        
        // Sistema de audio
        let audioContext = null;
        let soundsEnabled = true;
        
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        function playClickSound() {
            if (!soundsEnabled || !audioContext) return;
            
            // Crear un click mec√°nico realista usando ruido blanco filtrado
            const bufferSize = audioContext.sampleRate * 0.05; // 50ms
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const data = buffer.getChannelData(0);
            
            // Generar ruido blanco breve
            for (let i = 0; i < bufferSize; i++) {
                data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (bufferSize * 0.1));
            }
            
            const noise = audioContext.createBufferSource();
            noise.buffer = buffer;
            
            const filter = audioContext.createBiquadFilter();
            filter.type = 'bandpass';
            filter.frequency.value = 2000; // Frecuencia del click
            filter.Q.value = 5; // Resonancia para hacerlo m√°s n√≠tido
            
            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.05);
            
            noise.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            noise.start(audioContext.currentTime);
            noise.stop(audioContext.currentTime + 0.05);
        }
        
        // Agregar eventos de sonido a elementos interactivos
        function addSoundEvents() {
            // Esperar a que el DOM est√© listo
            setTimeout(() => {
                // Botones
                document.querySelectorAll('button').forEach(btn => {
                    btn.removeEventListener('click', playClickSound); // Evitar duplicados
                    btn.addEventListener('click', playClickSound);
                });
                
                // Links
                document.querySelectorAll('a').forEach(link => {
                    link.removeEventListener('click', playClickSound);
                    link.addEventListener('click', playClickSound);
                });
                
                // Tarjetas clickeables
                document.querySelectorAll('.cursor-pointer').forEach(card => {
                    card.removeEventListener('click', playClickSound);
                    card.addEventListener('click', playClickSound);
                });
            }, 100);
        }
        
        window.toggleSounds = function() {
            soundsEnabled = !soundsEnabled;
            const icon = soundsEnabled ? 'üîä' : 'üîá';
            const btn = document.getElementById('soundToggle');
            if (btn) btn.innerHTML = icon;
            // Guardar preferencia
            localStorage.setItem('soundsEnabled', soundsEnabled);
            // Reproducir sonido de confirmaci√≥n si se activa
            if (soundsEnabled && audioContext) {
                playClickSound();
            }
        };
        
        // Sistema de inactividad
        let inactivityTimer = null;
        let warningTimer = null;
        let showingWarning = false;
        const INACTIVITY_TIME = 80 * 1000; // 1 minuto 20 segundos
        const WARNING_TIME = 15 * 1000; // 15 segundos

        // ==================== INICIO DE SESI√ìN ====================
        
        function initLogin() {
            // SIEMPRE limpiar sesi√≥n anterior al cargar la p√°gina
            // Esto obliga a todos a iniciar sesi√≥n cada vez
            localStorage.removeItem('selectedUser');
            localStorage.removeItem('isAuthenticated');
            // NO limpiar isAdmin aqu√≠, se limpia solo al cerrar sesi√≥n
            
            // Mostrar lista de usuarios
            const userListDiv = document.getElementById('userList');
            userListDiv.innerHTML = teamMembers.map(member => `
                <button onclick="window.selectUser('${member}')" class="w-full text-left px-4 py-3 rounded-lg border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 transition duration-200 flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                        <span class="text-blue-600 font-bold text-lg">${member.charAt(0)}</span>
                    </div>
                    <span class="font-medium text-gray-700">${member}</span>
                </button>
            `).join('');
        }

        window.selectUser = function(userName) {
            currentUser = userName;
            // Guardar en localStorage para mantener el estado
            localStorage.setItem('selectedUser', userName);
            document.getElementById('selectedUserName').textContent = userName;
            document.getElementById('stepSelectUser').classList.add('hidden');
            document.getElementById('stepConnectGoogle').classList.remove('hidden');
        };

        window.backToUserSelection = function() {
            currentUser = null;
            localStorage.removeItem('selectedUser');
            document.getElementById('stepConnectGoogle').classList.add('hidden');
            document.getElementById('stepSelectUser').classList.remove('hidden');
        };

        window.authenticateGoogle = async function() {
            document.getElementById('stepConnectGoogle').classList.add('hidden');
            document.getElementById('stepLoading').classList.remove('hidden');
            
            try {
                await authenticateGoogleDrive();
                // Esperar un momento para mostrar que se est√° conectando
                setTimeout(() => {
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    // Guardar que ya se autentic√≥
                    localStorage.setItem('isAuthenticated', 'true');
                    // Guardar usuario actual
                    localStorage.setItem('selectedUser', currentUser);
                    // Cargar estado de admin desde localStorage
                    isAdmin = localStorage.getItem('isAdmin') === 'true';
                    console.log('isAdmin cargado:', isAdmin);
                    loadActivities();
                    // Iniciar sistema de inactividad
                    setupActivityListeners();
                }, 1000);
            } catch (error) {
                console.error('Error al autenticar:', error);
                // Si es error de cookies de terceros, mostrar mensaje m√°s claro
                if (error.message && error.message.includes('popup')) {
                    alert('Por favor, acepta las cookies de terceros en tu navegador para continuar.');
                } else {
                    alert('Error al conectar con Google. Intenta de nuevo.');
                }
                // Regresar al paso de conectar Google (NO a selecci√≥n de usuario)
                document.getElementById('stepLoading').classList.add('hidden');
                document.getElementById('stepConnectGoogle').classList.remove('hidden');
            }
        };

        document.getElementById('connectGoogleBtn')?.addEventListener('click', window.authenticateGoogle);

        // ==================== GOOGLE DRIVE ====================
        
        function initGoogleDrive() {
            console.log('üîµ Inicializando Google Drive...');
            google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        isGoogleDriveReady = true;
                        console.log('‚úÖ Google Drive autenticado');
                    }
                },
            });
        }
        
        function authenticateGoogleDrive() {
            return new Promise((resolve, reject) => {
                if (accessToken && isGoogleDriveReady) {
                    resolve(accessToken);
                    return;
                }
                
                const client = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email',
                    callback: async (response) => {
                        if (response.access_token) {
                            accessToken = response.access_token;
                            isGoogleDriveReady = true;
                            
                            // Obtener email del usuario
                            try {
                                const userInfoResponse = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                    headers: { 'Authorization': `Bearer ${accessToken}` }
                                });
                                const userInfo = await userInfoResponse.json();
                                userEmail = userInfo.email;
                                
                                // Verificar si es admin (Marco con email espec√≠fico)
                                if (currentUser === 'Marco Carrasco' && userEmail === 'ceysie.cuu@gmail.com') {
                                    isAdmin = true;
                                    localStorage.setItem('isAdmin', 'true');
                                    console.log('‚úÖ Acceso administrativo concedido');
                                } else {
                                    isAdmin = false;
                                    localStorage.removeItem('isAdmin');
                                }
                            } catch (error) {
                                console.error('Error obteniendo email:', error);
                            }
                            
                            resolve(accessToken);
                        } else {
                            reject(new Error('No se pudo obtener token'));
                        }
                    },
                });
                client.requestAccessToken();
            });
        }
        
        async function findFolder(folderName, parentFolderId) {
            const query = `name='${folderName}' and '${parentFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`;
            const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name)`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            if (!response.ok) throw new Error('Error al buscar carpeta');
            const result = await response.json();
            return result.files && result.files.length > 0 ? result.files[0].id : null;
        }
        
        async function createFolder(folderName, parentFolderId) {
            const metadata = {
                name: folderName,
                mimeType: 'application/vnd.google-apps.folder',
                parents: [parentFolderId]
            };
            const response = await fetch('https://www.googleapis.com/drive/v3/files?fields=id,name', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(metadata)
            });
            if (!response.ok) throw new Error('Error al crear carpeta');
            const result = await response.json();
            return result.id;
        }
        
        async function getOrCreateFolder(folderName, parentFolderId) {
            let folderId = await findFolder(folderName, parentFolderId);
            if (!folderId) {
                folderId = await createFolder(folderName, parentFolderId);
            }
            return folderId;
        }
        
        async function uploadToGoogleDrive(file, activityTitle, personName) {
            if (!accessToken) await authenticateGoogleDrive();
            
            const personFolderId = await getOrCreateFolder(personName, GOOGLE_DRIVE_FOLDER_ID);
            const activityFolderId = await getOrCreateFolder(activityTitle, personFolderId);
            
            const metadata = {
                name: file.name,
                parents: [activityFolderId],
                description: `Entregado por: ${personName} para ${activityTitle}`
            };
            
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);
            
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink,webContentLink', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${accessToken}` },
                body: form
            });
            
            if (!response.ok) {
                const error = await response.text();
                throw new Error(`Error al subir a Drive: ${error}`);
            }
            
            const result = await response.json();
            return {
                name: file.name,
                driveId: result.id,
                url: result.webViewLink,
                downloadUrl: result.webContentLink,
                size: file.size,
                type: 'file'
            };
        }

        // ==================== FIREBASE ====================
        
        async function loadActivities() {
            try {
                const testSnapshot = await getDocs(collection(db, 'activities'));
                console.log(`‚úÖ Conexi√≥n exitosa. Documentos: ${testSnapshot.size}`);
                
                const q = query(collection(db, 'activities'), orderBy('createdAt', 'desc'));
                
                onSnapshot(q, 
                    (snapshot) => {
                        activities = [];
                        snapshot.forEach((docSnap) => {
                            activities.push({ firebaseId: docSnap.id, ...docSnap.data() });
                        });
                        render();
                    },
                    (error) => {
                        console.error('‚ùå Error:', error);
                        alert('Error al cargar actividades');
                    }
                );
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error al conectar con la base de datos');
            }
        }

        async function createActivity() {
            if (!formData.title || !formData.description || !formData.deadline) {
                alert('Completa todos los campos'); 
                return;
            }
            // Usar el usuario autenticado
            formData.creator = currentUser;
            await addDoc(collection(db, 'activities'), { 
                ...formData, 
                submissions: [], 
                comments: [], // Inicializar array de comentarios
                createdAt: new Date().toISOString() 
            });
            showForm = false;
            formData = { creator: '', title: '', description: '', deadline: '', requiresSubmission: false };
            alert('Actividad creada'); 
            render();
        }

        async function deleteActivity() {
            if (deletePassword === 'eliminar26') {
                await deleteDoc(doc(db, 'activities', activityToDelete));
                showDeleteModal = false; 
                activityToDelete = null; 
                deletePassword = '';
                alert('Eliminada'); 
                render();
            } else { 
                alert('Contrase√±a incorrecta'); 
                deletePassword = ''; 
                render(); 
            }
        }

        async function submitDelivery() {
            if (selectedFiles.length === 0 && selectedLinks.length === 0) {
                alert('Por favor agrega al menos un archivo o enlace'); 
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            
            try {
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<div class="flex items-center justify-center gap-2"><div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div><span>Subiendo...</span></div>';
                }
                
                const submissionId = Date.now().toString();
                const personName = currentUser; // Usar el usuario autenticado
                
                // Subir archivos
                const uploadedFiles = [];
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    const uploadedFile = await uploadToGoogleDrive(file, currentActivity.title, personName);
                    uploadedFiles.push(uploadedFile);
                }
                
                // Agregar links
                const allItems = [
                    ...uploadedFiles,
                    ...selectedLinks.map(link => ({
                        name: link.name,
                        url: link.url,
                        type: 'link'
                    }))
                ];
                
                const submission = { 
                    id: submissionId, 
                    name: personName,
                    comments: submissionData.comments.trim(), 
                    files: allItems,
                    date: new Date().toISOString() 
                };
                
                await updateDoc(doc(db, 'activities', currentActivity.firebaseId), { 
                    submissions: [...currentActivity.submissions, submission] 
                });
                
                submissionData = { name: '', comments: '' }; 
                selectedFiles = [];
                selectedLinks = [];
                showModal = false;
                currentActivity = null;
                
                alert('‚úÖ Entrega registrada correctamente');
                render();
            } catch (error) {
                console.error('‚ùå Error:', error);
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Subir';
                }
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        async function sendComment(activityId) {
            const commentInput = document.getElementById(`commentInput-${activityId}`);
            const commentText = commentInput?.value.trim();
            
            if (!commentText) {
                alert('Escribe un comentario');
                return;
            }
            
            const activity = activities.find(a => a.firebaseId === activityId);
            if (!activity) return;
            
            const newComment = {
                id: Date.now().toString(),
                user: currentUser,
                text: commentText,
                date: new Date().toISOString()
            };
            
            const updatedComments = [...(activity.comments || []), newComment];
            
            try {
                await updateDoc(doc(db, 'activities', activityId), { 
                    comments: updatedComments 
                });
                commentInput.value = '';
                // Hacer scroll al final despu√©s de un breve delay para que el DOM se actualice
                setTimeout(() => {
                    const commentsDiv = document.getElementById(`commentsScroll-${activityId}`);
                    if (commentsDiv) {
                        commentsDiv.scrollTop = commentsDiv.scrollHeight;
                    }
                }, 100);
            } catch (error) {
                console.error('Error al enviar comentario:', error);
                alert('Error al enviar comentario');
            }
        }

        async function deleteComment(activityId, commentId) {
            if (!isAdmin) {
                alert('No tienes permisos para eliminar comentarios');
                return;
            }
            
            if (!confirm('¬øEliminar este comentario?')) return;
            
            const activity = activities.find(a => a.firebaseId === activityId);
            if (!activity) return;
            
            const updatedComments = activity.comments.filter(c => c.id !== commentId);
            
            try {
                await updateDoc(doc(db, 'activities', activityId), { 
                    comments: updatedComments 
                });
            } catch (error) {
                console.error('Error al eliminar comentario:', error);
                alert('Error al eliminar comentario');
            }
        }

        window.sendComment = sendComment;
        window.deleteComment = deleteComment;

        window.toggleComments = function(activityId) {
            const commentsDiv = document.getElementById(`comments-${activityId}`);
            const icon = document.getElementById(`commentIcon-${activityId}`);
            
            if (commentsDiv.classList.contains('hidden')) {
                commentsDiv.classList.remove('hidden');
                icon.textContent = '‚ñº';
                openComments[activityId] = true;
                
                // Scroll al final cuando se abren los comentarios
                setTimeout(() => {
                    const scrollDiv = document.getElementById(`commentsScroll-${activityId}`);
                    if (scrollDiv) {
                        scrollDiv.scrollTop = scrollDiv.scrollHeight;
                    }
                }, 50);
            } else {
                commentsDiv.classList.add('hidden');
                icon.textContent = '‚ñ∂';
                openComments[activityId] = false;
            }
        };

        window.logout = function() {
            if (confirm('¬øEst√°s seguro que deseas cerrar sesi√≥n?')) {
                // Limpiar localStorage
                localStorage.removeItem('selectedUser');
                localStorage.removeItem('isAuthenticated');
                localStorage.removeItem('isAdmin');
                isAdmin = false;
                // Recargar la p√°gina
                location.reload();
            }
        };
        
        // Sistema de detecci√≥n de inactividad
        function resetInactivityTimer() {
            // Limpiar timers existentes
            if (inactivityTimer) clearTimeout(inactivityTimer);
            if (warningTimer) clearTimeout(warningTimer);
            
            // Cerrar advertencia si est√° abierta
            if (showingWarning) {
                closeWarning();
            }
            
            // Iniciar nuevo timer de inactividad
            inactivityTimer = setTimeout(() => {
                showInactivityWarning();
            }, INACTIVITY_TIME);
        }
        
        function showInactivityWarning() {
            showingWarning = true;
            
            // Crear modal de advertencia
            const warningDiv = document.createElement('div');
            warningDiv.id = 'inactivityWarning';
            warningDiv.className = 'fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
            warningDiv.innerHTML = `
                <div class="bg-white rounded-lg p-8 max-w-md text-center animate-pulse">
                    <div class="text-6xl mb-4">‚è∞</div>
                    <h2 class="text-2xl font-bold text-red-600 mb-4">Sesi√≥n por inactividad</h2>
                    <p class="text-gray-700 mb-2">No hemos detectado actividad en 1 minuto 20 segundos</p>
                    <p class="text-gray-900 font-bold text-xl mb-4">Cerrando sesi√≥n en <span id="countdown">15</span> segundos</p>
                    <button onclick="window.cancelAutoLogout()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg w-full">
                        Mantener sesi√≥n activa
                    </button>
                </div>
            `;
            document.body.appendChild(warningDiv);
            
            // Countdown
            let secondsLeft = 15;
            const countdownInterval = setInterval(() => {
                secondsLeft--;
                const countdownEl = document.getElementById('countdown');
                if (countdownEl) {
                    countdownEl.textContent = secondsLeft;
                }
                if (secondsLeft <= 0) {
                    clearInterval(countdownInterval);
                }
            }, 1000);
            
            // Auto logout despu√©s de 15 segundos
            warningTimer = setTimeout(() => {
                clearInterval(countdownInterval);
                autoLogout();
            }, WARNING_TIME);
        }
        
        function closeWarning() {
            const warningDiv = document.getElementById('inactivityWarning');
            if (warningDiv) {
                warningDiv.remove();
            }
            showingWarning = false;
        }
        
        window.cancelAutoLogout = function() {
            if (warningTimer) clearTimeout(warningTimer);
            closeWarning();
            resetInactivityTimer();
        };
        
        function autoLogout() {
            closeWarning();
            // Desactivar protecci√≥n
            deactivateCloseProtection();
            localStorage.removeItem('selectedUser');
            localStorage.removeItem('isAuthenticated');
            localStorage.removeItem('attemptedClose');
            alert('Sesi√≥n cerrada por inactividad');
            location.reload();
        }
        
        // Detectar actividad del usuario
        function setupActivityListeners() {
            const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            events.forEach(event => {
                document.addEventListener(event, resetInactivityTimer, true);
            });
            
            // Iniciar el timer
            resetInactivityTimer();
        }

        function handleFileSelect(e) {
            Array.from(e.target.files).forEach(f => {
                selectedFiles.push(f);
            });
            updateFileList();
        }
        
        function updateFileList() {
            const fileListContainer = document.getElementById('fileListContainer');
            if (fileListContainer) {
                const filesHTML = selectedFiles.map((f, i) => 
                    `<div class="flex justify-between bg-blue-50 p-2 rounded text-xs border border-blue-200">
                        <span class="truncate">üìÑ ${f.name}</span>
                        <button onclick="window.removeFileAt(${i})" class="text-red-600 ml-2">‚úï</button>
                    </div>`
                ).join('');
                
                const linksHTML = selectedLinks.map((link, i) => 
                    `<div class="flex justify-between bg-green-50 p-2 rounded text-xs border border-green-200">
                        <span class="truncate">üîó ${link.name}</span>
                        <button onclick="window.removeLinkAt(${i})" class="text-red-600 ml-2">‚úï</button>
                    </div>`
                ).join('');
                
                fileListContainer.innerHTML = filesHTML + linksHTML;
            }
        }

        window.addLink = function() {
            const linkName = document.getElementById('linkName').value.trim();
            const linkURL = document.getElementById('linkURL').value.trim();
            
            if (!linkName || !linkURL) {
                alert('Completa el nombre y la URL del enlace');
                return;
            }
            
            selectedLinks.push({ name: linkName, url: linkURL });
            document.getElementById('linkName').value = '';
            document.getElementById('linkURL').value = '';
            updateFileList();
        };

        function getFilteredActivities() {
            return activities.filter(a => {
                const matchSearch = !searchTerm || a.title.toLowerCase().includes(searchTerm.toLowerCase()) || a.description.toLowerCase().includes(searchTerm.toLowerCase());
                const matchMember = !filterMember || a.creator === filterMember;
                const matchStatus = !filterStatus || (filterStatus === 'activa' ? new Date(a.deadline) >= new Date() : new Date(a.deadline) < new Date());
                const matchMonth = !filterMonth || (a.createdAt && a.createdAt.startsWith(filterMonth));
                return matchSearch && matchMember && matchStatus && matchMonth;
            });
        }

        function getMemberStats() {
            return teamMembers.map(member => {
                const created = activities.filter(a => a.creator === member).length;
                const submissions = activities.reduce((sum, act) => sum + act.submissions.filter(s => s.name === member).length, 0);
                const totalFiles = activities.reduce((sum, act) => sum + act.submissions.filter(s => s.name === member).reduce((fs, s) => fs + s.files.length, 0), 0);
                const submissionDetails = activities.map(act => ({ activity: act.title, submissions: act.submissions.filter(s => s.name === member) })).filter(i => i.submissions.length > 0);
                return { name: member, created, submissions, totalFiles, submissionDetails };
            });
        }

        function render() {
            const stats = {
                total: activities.length,
                expired: activities.filter(a => new Date(a.deadline) < new Date()).length,
                active: activities.filter(a => new Date(a.deadline) >= new Date()).length,
                submissions: activities.reduce((sum, a) => sum + a.submissions.length, 0)
            };
            const filtered = getFilteredActivities();

            document.getElementById('app').innerHTML = `
                <div class="bg-gradient-to-r from-blue-800 to-blue-900 text-white py-6">
                    <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <div class="bg-white rounded-lg p-2">
                                <img src="https://sds.chihuahua.gob.mx/sisco/imagenes/logovertical.png" alt="SDHyBC" class="h-12 w-auto">
                            </div>
                            <div>
                                <h1 class="text-3xl font-bold">Sistema de Seguimiento</h1>
                                <p class="text-blue-200">SDHyBC</p>
                            </div>
                        </div>
                        <div class="text-right flex items-center gap-4">
                            <div>
                                <p class="text-sm text-blue-200">Sesi√≥n iniciada como:</p>
                                <p class="font-bold">${currentUser}${isAdmin ? ' üëë Admin' : ''}</p>
                            </div>
                            <button id="soundToggle" onclick="window.toggleSounds()" class="bg-blue-700 hover:bg-blue-600 px-3 py-2 rounded-lg text-xl transition" title="Activar/Desactivar sonidos">
                                üîä
                            </button>
                            <a href="https://docs.google.com/spreadsheets/d/1G6o47Gc_Sb-6Vx1w9gwOfcKtahuRUYuEW4A6kiPHKes/edit?usp=sharing" target="_blank" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-lg text-sm transition flex items-center gap-2">
                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                                </svg>
                                Registro Quincenal
                            </a>
                            ${isAdmin ? `<a href="https://drive.google.com/drive/folders/${GOOGLE_DRIVE_FOLDER_ID}" target="_blank" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm transition flex items-center gap-2">
                                üìÅ Ver Drive
                            </a>` : ''}
                            <button onclick="window.logout()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg text-sm font-bold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300">
                                üö™ Cerrar sesi√≥n
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Banner de recordatorio siempre visible -->
                <div class="bg-gradient-to-r from-yellow-400 via-orange-400 to-red-400 text-white py-3 shadow-md">
                    <div class="max-w-7xl mx-auto px-4 flex items-center justify-center gap-3">
                        <svg class="w-6 h-6 animate-bounce" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <p class="text-sm md:text-base font-bold">
                            ‚ö†Ô∏è IMPORTANTE: Recuerda CERRAR SESI√ìN usando el bot√≥n rojo üö™ cuando termines de usar el sistema
                        </p>
                        <svg class="w-6 h-6 animate-bounce" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>
                <div class="max-w-7xl mx-auto px-4 py-8">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-blue-600"><p class="text-xs text-gray-600">Total</p><p class="text-2xl font-bold">${stats.total}</p></div>
                        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-red-500"><p class="text-xs text-gray-600">Vencidas</p><p class="text-2xl font-bold text-red-700">${stats.expired}</p></div>
                        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-yellow-500"><p class="text-xs text-gray-600">Activas</p><p class="text-2xl font-bold text-yellow-700">${stats.active}</p></div>
                        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-green-500"><p class="text-xs text-gray-600">Entregas</p><p class="text-2xl font-bold text-green-700">${stats.submissions}</p></div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <div class="flex flex-col gap-4">
                            <div class="flex gap-4">
                                <input type="text" id="searchInput" placeholder="Buscar..." value="${searchTerm}" oninput="window.updateSearch(this.value)" class="flex-1 px-4 py-2 border rounded-lg">
                                <button onclick="window.toggleForm()" class="bg-blue-600 text-white px-6 py-2 rounded-lg">+ Crear</button>
                                <button onclick="window.toggleStats()" class="bg-green-600 text-white px-6 py-2 rounded-lg">${showMemberStats ? 'Actividades' : 'Seguimiento'}</button>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">Usuario</label>
                                    <select id="filterMember" class="w-full px-4 py-2 border rounded-lg"><option value="">Todos</option>${teamMembers.map(m => `<option value="${m}" ${filterMember === m ? 'selected' : ''}>${m}</option>`).join('')}</select>
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">Estado de actividad</label>
                                    <select id="filterStatus" class="w-full px-4 py-2 border rounded-lg"><option value="">Todos</option><option value="activa" ${filterStatus === 'activa' ? 'selected' : ''}>Activas</option><option value="vencida" ${filterStatus === 'vencida' ? 'selected' : ''}>Vencidas</option></select>
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">Mes de creaci√≥n</label>
                                    <select id="filterMonth" class="w-full px-4 py-2 border rounded-lg">
                                        <option value="">Todos los meses</option>
                                        <option value="2026-01">Enero 2026</option>
                                        <option value="2026-02">Febrero 2026</option>
                                        <option value="2026-03">Marzo 2026</option>
                                        <option value="2026-04">Abril 2026</option>
                                        <option value="2026-05">Mayo 2026</option>
                                        <option value="2026-06">Junio 2026</option>
                                        <option value="2026-07">Julio 2026</option>
                                        <option value="2026-08">Agosto 2026</option>
                                        <option value="2026-09">Septiembre 2026</option>
                                        <option value="2026-10">Octubre 2026</option>
                                        <option value="2026-11">Noviembre 2026</option>
                                        <option value="2026-12">Diciembre 2026</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    ${showForm ? `<div class="bg-white rounded-lg shadow p-6 mb-6"><h2 class="text-xl font-bold mb-4">Nueva Actividad</h2><div class="space-y-4"><div><label class="block text-sm mb-2">T√≠tulo *</label><input type="text" id="title" class="w-full px-4 py-2 border rounded-lg"></div><div><label class="block text-sm mb-2">Descripci√≥n *</label><textarea id="description" rows="4" class="w-full px-4 py-2 border rounded-lg"></textarea></div><div><label class="block text-sm mb-2">L√≠mite *</label><input type="datetime-local" id="deadline" class="w-full px-4 py-2 border rounded-lg"></div><label class="flex items-center gap-2"><input type="checkbox" id="requiresSubmission">Requiere entregas</label><div class="flex gap-3"><button onclick="window.saveActivity()" class="bg-blue-600 text-white px-6 py-2 rounded-lg">Crear</button><button onclick="window.toggleForm()" class="bg-gray-200 px-6 py-2 rounded-lg">Cancelar</button></div></div></div>` : ''}
                    ${showMemberStats ? `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${getMemberStats().map(m => `
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold mb-3">${m.name}</h3>
                            <div class="grid grid-cols-3 gap-2 text-center mb-4">
                                <div class="bg-blue-50 rounded p-2">
                                    <p class="text-2xl font-bold text-blue-600">${m.created}</p>
                                    <p class="text-xs text-gray-600">Creadas</p>
                                </div>
                                <div class="bg-green-50 rounded p-2">
                                    <p class="text-2xl font-bold text-green-600">${m.submissions}</p>
                                    <p class="text-xs text-gray-600">Entregas</p>
                                </div>
                                <div class="bg-purple-50 rounded p-2">
                                    <p class="text-2xl font-bold text-purple-600">${m.totalFiles}</p>
                                    <p class="text-xs text-gray-600">Archivos</p>
                                </div>
                            </div>
                            ${m.submissionDetails.length > 0 ? `
                                <button onclick="window.openFilesModal('${m.name}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    Ver todos los archivos (${m.totalFiles})
                                </button>
                            ` : '<p class="text-gray-500 text-sm text-center py-4 border-t">Sin entregas</p>'}
                        </div>
                    `).join('')}</div>` : `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${filtered.length === 0 ? '<div class="col-span-2 bg-white rounded-lg shadow p-12 text-center"><p class="text-gray-500">No hay actividades</p></div>' : filtered.map(act => {
                        const isExpired = new Date(act.deadline) < new Date();
                        const activityComments = act.comments || [];
                        return `<div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex gap-3">
                                    <span class="px-3 py-1 rounded-full text-xs font-bold ${isExpired ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${isExpired ? 'VENCIDA' : 'ACTIVA'}</span>
                                    ${act.requiresSubmission ? '<span class="px-3 py-1 rounded-full text-xs bg-blue-100 text-blue-800">Requiere entregas</span>' : ''}
                                </div>
                                ${isAdmin ? `<button onclick="window.openDeleteModal('${act.firebaseId}')" class="text-red-600 hover:bg-red-50 p-2 rounded">üóëÔ∏è</button>` : '<div class="w-10"></div>'}
                            </div>
                            <h3 class="text-xl font-bold mb-2">${act.title}</h3>
                            <p class="text-gray-600 mb-3">${act.description}</p>
                            
                            <div class="grid grid-cols-${act.requiresSubmission ? '2' : '1'} gap-4 mb-3">
                                <div class="text-sm text-gray-600">
                                    <p><strong>Creador:</strong> ${act.creator}</p>
                                    <p><strong>L√≠mite:</strong> ${new Date(act.deadline).toLocaleDateString('es-MX')} ${new Date(act.deadline).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' })}</p>
                                    ${act.requiresSubmission ? `<p><strong>Entregas:</strong> ${act.submissions.length}</p>` : ''}
                                </div>
                                
                                ${act.requiresSubmission ? `
                                <div class="flex items-center">
                                    <button onclick="window.openSubmissionModal('${act.firebaseId}')" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700">Ver/Subir Archivos</button>
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- Comentarios colapsables -->
                            <div class="border-t pt-3">
                                <button onclick="window.toggleComments('${act.firebaseId}')" class="flex items-center gap-2 text-sm font-semibold text-gray-700 hover:text-blue-600 mb-2">
                                    <span id="commentIcon-${act.firebaseId}">${openComments[act.firebaseId] ? '‚ñº' : '‚ñ∂'}</span>
                                    üí¨ Comentarios (${activityComments.length})
                                </button>
                                <div id="comments-${act.firebaseId}" class="${openComments[act.firebaseId] ? '' : 'hidden'}">
                                    <div class="bg-gray-50 rounded p-2 mb-2 max-h-60 overflow-y-auto" id="commentsScroll-${act.firebaseId}">
                                        ${activityComments.length === 0 ? '<p class="text-xs text-gray-400 text-center py-2">Sin comentarios a√∫n</p>' : activityComments.map(comment => `
                                            <div class="mb-1.5 text-xs group">
                                                <div class="flex items-start justify-between">
                                                    <div class="flex-1">
                                                        <span class="font-semibold text-blue-600">${comment.user.split(' ')[0]}:</span>
                                                        <span class="text-gray-700">${comment.text}</span>
                                                    </div>
                                                    <div class="flex items-center gap-1 ml-2">
                                                        <span class="text-gray-400 text-xs">${new Date(comment.date).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' })}</span>
                                                        ${isAdmin ? `<button onclick="window.deleteComment('${act.firebaseId}', '${comment.id}')" class="text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition flex-shrink-0">‚úï</button>` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="flex gap-2">
                                        <input type="text" id="commentInput-${act.firebaseId}" placeholder="Escribe un comentario..." class="flex-1 px-3 py-1.5 text-sm border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" onkeypress="if(event.key==='Enter') window.sendComment('${act.firebaseId}')">
                                        <button onclick="window.sendComment('${act.firebaseId}')" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-700">Enviar</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    }).join('')}</div>`}
                </div>
                ${showModal && currentActivity ? `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto"><div class="flex justify-between mb-4"><div class="flex-1 pr-4"><h3 class="text-xl font-bold">${currentActivity.title}</h3><p class="text-sm text-gray-600 mt-1">${currentActivity.description}</p><p class="text-xs text-gray-500 mt-1">L√≠mite: ${new Date(currentActivity.deadline).toLocaleString('es-MX')}</p></div><button onclick="window.closeModal()" class="text-gray-400">‚úï</button></div><div class="border-t pt-4 mb-4"><h4 class="font-bold mb-3">Subir Entrega</h4><div class="space-y-3"><textarea id="subComments" rows="2" placeholder="Comentarios..." class="w-full px-3 py-2 text-sm border rounded-lg"></textarea><div class="border-2 border-dashed rounded-lg p-4 text-center cursor-pointer hover:border-blue-500" onclick="document.getElementById('fileInput').click()"><p class="text-xs">üìÅ Clic para seleccionar archivos</p></div><input type="file" id="fileInput" multiple class="hidden"><div class="bg-gray-50 p-3 rounded-lg"><p class="text-xs font-bold mb-2">O agregar enlace:</p><div class="space-y-2"><input type="text" id="linkName" placeholder="Nombre del enlace" class="w-full px-3 py-2 text-xs border rounded-lg"><input type="url" id="linkURL" placeholder="https://ejemplo.com" class="w-full px-3 py-2 text-xs border rounded-lg"><button onclick="window.addLink()" class="w-full bg-green-600 text-white px-3 py-2 rounded-lg text-xs">+ Agregar enlace</button></div></div><div id="fileListContainer" class="space-y-1 max-h-32 overflow-y-auto"></div><button id="submitBtn" onclick="window.uploadSubmission()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">üì§ Subir</button></div></div><div class="border-t pt-4"><h4 class="font-bold mb-3">Entregas (${currentActivity.submissions.length})</h4>${currentActivity.submissions.length === 0 ? '<p class="text-center text-gray-500 py-4 text-sm">Sin entregas</p>' : `<div class="space-y-3 max-h-64 overflow-y-auto">${currentActivity.submissions.map(s => `<div class="border rounded-lg p-3 bg-gray-50"><p class="font-bold text-sm">${s.name}</p><p class="text-xs text-gray-500">${new Date(s.date).toLocaleString('es-MX')}</p>${s.comments ? `<p class="text-xs text-gray-700 mt-1">${s.comments}</p>` : ''}<div class="mt-2 space-y-1">${s.files.map(f => f.type === 'link' ? `<a href="${f.url}" target="_blank" class="flex items-center gap-2 text-xs text-green-600 hover:bg-green-50 px-2 py-1 rounded">üîó <span class="truncate">${f.name}</span></a>` : `<a href="${f.url}" target="_blank" class="flex items-center gap-2 text-xs text-blue-600 hover:bg-blue-100 px-2 py-1 rounded">üìé <span class="truncate">${f.name}</span></a>`).join('')}</div></div>`).join('')}</div>`}</div></div></div>` : ''}
                ${showDeleteModal ? `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div class="bg-white rounded-lg p-6 max-w-md w-full"><h3 class="text-xl font-bold mb-4">Eliminar</h3><p class="text-gray-600 mb-4">Contrase√±a:</p><input type="password" id="delPassword" class="w-full px-4 py-2 border rounded-lg mb-4"><div class="flex gap-3"><button onclick="window.confirmDelete()" class="flex-1 bg-red-600 text-white px-6 py-2 rounded-lg">Eliminar</button><button onclick="window.closeDeleteModal()" class="flex-1 bg-gray-200 px-6 py-2 rounded-lg">Cancelar</button></div></div></div>` : ''}
                ${showFilesModal && currentMemberFiles ? `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-[90vh] flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-2xl font-bold">Archivos de ${currentMemberFiles.name}</h3>
                                <button onclick="window.closeFilesModal()" class="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
                            </div>
                            
                            <div class="mb-4 grid grid-cols-3 gap-4 text-center">
                                <div class="bg-blue-50 rounded p-3">
                                    <p class="text-3xl font-bold text-blue-600">${currentMemberFiles.created}</p>
                                    <p class="text-sm text-gray-600">Actividades creadas</p>
                                </div>
                                <div class="bg-green-50 rounded p-3">
                                    <p class="text-3xl font-bold text-green-600">${currentMemberFiles.submissions}</p>
                                    <p class="text-sm text-gray-600">Entregas realizadas</p>
                                </div>
                                <div class="bg-purple-50 rounded p-3">
                                    <p class="text-3xl font-bold text-purple-600">${currentMemberFiles.totalFiles}</p>
                                    <p class="text-sm text-gray-600">Archivos totales</p>
                                </div>
                            </div>
                            
                            <div class="mb-4 grid grid-cols-2 gap-3">
                                <input 
                                    type="text" 
                                    placeholder="üîç Buscar por actividad, comentario o archivo..." 
                                    value="${filesSearchTerm}"
                                    oninput="window.updateFilesSearch(this.value)"
                                    class="px-4 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                <select 
                                    onchange="window.updateFilesMonth(this.value)"
                                    class="px-4 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="">üìÖ Todos los meses</option>
                                    <option value="2026-01" ${filesFilterMonth === '2026-01' ? 'selected' : ''}>Enero 2026</option>
                                    <option value="2026-02" ${filesFilterMonth === '2026-02' ? 'selected' : ''}>Febrero 2026</option>
                                    <option value="2026-03" ${filesFilterMonth === '2026-03' ? 'selected' : ''}>Marzo 2026</option>
                                    <option value="2026-04" ${filesFilterMonth === '2026-04' ? 'selected' : ''}>Abril 2026</option>
                                    <option value="2026-05" ${filesFilterMonth === '2026-05' ? 'selected' : ''}>Mayo 2026</option>
                                    <option value="2026-06" ${filesFilterMonth === '2026-06' ? 'selected' : ''}>Junio 2026</option>
                                    <option value="2026-07" ${filesFilterMonth === '2026-07' ? 'selected' : ''}>Julio 2026</option>
                                    <option value="2026-08" ${filesFilterMonth === '2026-08' ? 'selected' : ''}>Agosto 2026</option>
                                    <option value="2026-09" ${filesFilterMonth === '2026-09' ? 'selected' : ''}>Septiembre 2026</option>
                                    <option value="2026-10" ${filesFilterMonth === '2026-10' ? 'selected' : ''}>Octubre 2026</option>
                                    <option value="2026-11" ${filesFilterMonth === '2026-11' ? 'selected' : ''}>Noviembre 2026</option>
                                    <option value="2026-12" ${filesFilterMonth === '2026-12' ? 'selected' : ''}>Diciembre 2026</option>
                                </select>
                            </div>
                            
                            <div class="overflow-y-auto flex-1">
                                ${(() => {
                                    const filteredDetails = getFilteredSubmissions(currentMemberFiles.submissionDetails);
                                    if (filteredDetails.length === 0) {
                                        return '<div class="text-center py-8 text-gray-500">No se encontraron resultados</div>';
                                    }
                                    return filteredDetails.map(detail => `
                                        <div class="border rounded-lg p-4 bg-gray-50 mb-4">
                                            <h4 class="font-bold text-lg mb-3 text-blue-600">üìã ${detail.activity}</h4>
                                            ${detail.submissions.map(sub => `
                                                <div class="bg-white rounded p-3 mb-2 shadow-sm">
                                                    <div class="flex justify-between items-start mb-2">
                                                        <p class="text-sm font-semibold text-gray-700">üìÖ ${new Date(sub.date).toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                                                    </div>
                                                    ${sub.comments ? `<p class="text-sm text-gray-600 mb-2"><strong>üí¨ Comentario:</strong> ${sub.comments}</p>` : ''}
                                                    <div class="border-t pt-2 mt-2">
                                                        <p class="text-xs font-semibold text-gray-700 mb-2">üìé Archivos (${sub.files.length}):</p>
                                                        <div class="space-y-1">
                                                            ${sub.files.map(f => f.type === 'link' ? 
                                                                `<a href="${f.url}" target="_blank" class="flex items-center gap-2 text-sm text-green-600 hover:bg-green-50 px-2 py-1 rounded">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
                                                                    <span class="truncate">${f.name}</span>
                                                                </a>` : 
                                                                `<a href="${f.url}" target="_blank" class="flex items-center gap-2 text-sm text-blue-600 hover:bg-blue-50 px-2 py-1 rounded">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                                                    <span class="truncate">${f.name}</span>
                                                                </a>`
                                                            ).join('')}
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    `).join('');
                                })()}
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
            document.getElementById('filterMember')?.addEventListener('change', (e) => { filterMember = e.target.value; render(); });
            document.getElementById('filterStatus')?.addEventListener('change', (e) => { filterStatus = e.target.value; render(); });
            document.getElementById('filterMonth')?.addEventListener('change', (e) => { filterMonth = e.target.value; render(); });
            document.getElementById('fileInput')?.addEventListener('change', handleFileSelect);
        }

        window.updateSearch = function(value) {
            searchTerm = value;
            // Guardar el foco y la posici√≥n del cursor
            const searchInput = document.getElementById('searchInput');
            const cursorPosition = searchInput?.selectionStart;
            
            render();
            
            // Restaurar el foco despu√©s del render
            setTimeout(() => {
                const newSearchInput = document.getElementById('searchInput');
                if (newSearchInput) {
                    newSearchInput.focus();
                    newSearchInput.setSelectionRange(cursorPosition, cursorPosition);
                }
            }, 0);
        };

        window.toggleForm = () => { showForm = !showForm; render(); };
        window.toggleStats = () => { showMemberStats = !showMemberStats; render(); };
        window.saveActivity = () => { 
            formData = { 
                title: document.getElementById('title').value, 
                description: document.getElementById('description').value, 
                deadline: document.getElementById('deadline').value, 
                requiresSubmission: document.getElementById('requiresSubmission').checked 
            }; 
            createActivity(); 
        };
        window.openSubmissionModal = (id) => { 
            currentActivity = activities.find(a => a.firebaseId === id); 
            showModal = true; 
            selectedFiles = []; 
            selectedLinks = [];
            submissionData = { name: '', comments: '' }; 
            render(); 
        };
        window.closeModal = () => { showModal = false; currentActivity = null; selectedFiles = []; selectedLinks = []; render(); };
        window.uploadSubmission = () => { 
            submissionData = { comments: document.getElementById('subComments').value }; 
            submitDelivery(); 
        };
        window.removeFileAt = (i) => { selectedFiles.splice(i, 1); updateFileList(); };
        window.removeLinkAt = (i) => { selectedLinks.splice(i, 1); updateFileList(); };
        window.openDeleteModal = (id) => { activityToDelete = id; showDeleteModal = true; deletePassword = ''; render(); };
        window.closeDeleteModal = () => { showDeleteModal = false; activityToDelete = null; deletePassword = ''; render(); };
        window.confirmDelete = () => { deletePassword = document.getElementById('delPassword').value; deleteActivity(); };
        
        window.openFilesModal = (memberName) => {
            const stats = getMemberStats();
            currentMemberFiles = stats.find(m => m.name === memberName);
            showFilesModal = true;
            filesSearchTerm = '';
            filesFilterMonth = '';
            render();
        };
        window.closeFilesModal = () => {
            showFilesModal = false;
            currentMemberFiles = null;
            filesSearchTerm = '';
            filesFilterMonth = '';
            render();
        };
        
        window.updateFilesSearch = (value) => {
            filesSearchTerm = value;
            // Guardar el foco y la posici√≥n del cursor
            const searchInput = document.querySelector('input[placeholder*="Buscar por actividad"]');
            const cursorPosition = searchInput?.selectionStart;
            
            render();
            
            // Restaurar el foco despu√©s del render
            setTimeout(() => {
                const newSearchInput = document.querySelector('input[placeholder*="Buscar por actividad"]');
                if (newSearchInput) {
                    newSearchInput.focus();
                    newSearchInput.setSelectionRange(cursorPosition, cursorPosition);
                }
            }, 0);
        };
        
        window.updateFilesMonth = (value) => {
            filesFilterMonth = value;
            render();
        };
        
        function getFilteredSubmissions(submissionDetails) {
            return submissionDetails.map(detail => {
                const filteredSubs = detail.submissions.filter(sub => {
                    const matchSearch = !filesSearchTerm || 
                        detail.activity.toLowerCase().includes(filesSearchTerm.toLowerCase()) ||
                        sub.comments?.toLowerCase().includes(filesSearchTerm.toLowerCase()) ||
                        sub.files.some(f => f.name.toLowerCase().includes(filesSearchTerm.toLowerCase()));
                    
                    const matchMonth = !filesFilterMonth || sub.date.startsWith(filesFilterMonth);
                    
                    return matchSearch && matchMonth;
                });
                
                return { ...detail, submissions: filteredSubs };
            }).filter(detail => detail.submissions.length > 0);
        }
        
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { if (showModal) window.closeModal(); if (showDeleteModal) window.closeDeleteModal(); } });
        
        window.addEventListener('load', () => {
            setTimeout(initGoogleDrive, 1000);
            initLogin();
            // Cargar preferencia de sonidos
            const savedSoundPref = localStorage.getItem('soundsEnabled');
            if (savedSoundPref !== null) {
                soundsEnabled = savedSoundPref === 'true';
            }
            // Inicializar audio con interacci√≥n del usuario
            document.addEventListener('click', () => {
                if (!audioContext) {
                    initAudio();
                }
            }, { once: true });
        });
        
        // Agregar eventos de sonido despu√©s de cada render
        function addSoundsAfterRender() {
            addSoundEvents();
        }
        
        // Observer para detectar cambios en el DOM y agregar sonidos
        const observer = new MutationObserver(() => {
            addSoundEvents();
        });
        
        // Observar cambios en el app
        setTimeout(() => {
            const appElement = document.getElementById('app');
            if (appElement) {
                observer.observe(appElement, { childList: true, subtree: true });
            }
        }, 1000);
    </script>
</body>
</html>


