<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Seguimiento - SDHyBC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body class="bg-gray-50">
    <!-- CONFIGURACI√ìN: Cambia estos valores -->
    <script>
        // Configuraci√≥n de Google Drive
        const GOOGLE_CLIENT_ID = '649876702440-l91gfiqiu47n8u7o3sip8vpr99ivqdbg.apps.googleusercontent.com';
        const GOOGLE_DRIVE_FOLDER_ID = '1u31rHppvtVhC7BAl2ZTYXUUxZt_Xt_lb';
    </script>

    <div id="loadingScreen" class="fixed inset-0 bg-gray-50 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Cargando sistema...</p>
        </div>
    </div>
    <div id="app"></div>

    <script type="module">
        console.log('üîµ Iniciando script...');
        
        // Importar Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        console.log('‚úÖ Firebase imports cargados');

        const firebaseConfig = {
            apiKey: "AIzaSyA-wYzNg1Gh1Hp5ctHlAHbnu7IhnVIb0og",
            authDomain: "sdhybc-9dc43.firebaseapp.com",
            projectId: "sdhybc-9dc43",
            storageBucket: "sdhybc-9dc43.appspot.com",
            messagingSenderId: "953815565213",
            appId: "1:953815565213:web:0cb8995235b5cc6e0aa574"
        };

        let app, db;
        let accessToken = null;
        let isGoogleDriveReady = false;
        
        try {
            console.log('üîµ Inicializando Firebase App...');
            app = initializeApp(firebaseConfig);
            console.log('‚úÖ Firebase App inicializado');
            
            console.log('üîµ Inicializando Firestore...');
            db = getFirestore(app);
            console.log('‚úÖ Firestore inicializado');
            
        } catch (error) {
            console.error('‚ùå Error fatal:', error);
            document.getElementById('loadingScreen').innerHTML = `
                <div class="text-center max-w-2xl mx-auto p-6">
                    <div class="text-red-600 text-6xl mb-4">‚ö†Ô∏è</div>
                    <h2 class="text-xl font-bold mb-2">Error de Inicializaci√≥n</h2>
                    <p class="text-gray-600 mb-4">No se pudo conectar con Firebase</p>
                    <button onclick="location.reload()" class="bg-blue-600 text-white px-6 py-2 rounded-lg">Reintentar</button>
                </div>
            `;
            throw error;
        }
        
        // Inicializar Google Drive API
        function initGoogleDrive() {
            console.log('üîµ Inicializando Google Drive...');
            
            if (GOOGLE_CLIENT_ID.includes('TU_CLIENT_ID')) {
                console.warn('‚ö†Ô∏è Google Drive no configurado. Edita el archivo y agrega tu Client ID.');
                return;
            }
            
            google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        isGoogleDriveReady = true;
                        console.log('‚úÖ Google Drive autenticado');
                    }
                },
            });
        }
        
        // Autenticar con Google Drive
        function authenticateGoogleDrive() {
            return new Promise((resolve, reject) => {
                if (accessToken && isGoogleDriveReady) {
                    resolve(accessToken);
                    return;
                }
                
                console.log('üîµ Solicitando autenticaci√≥n...');
                const client = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/drive.file',
                    callback: (response) => {
                        if (response.access_token) {
                            accessToken = response.access_token;
                            isGoogleDriveReady = true;
                            console.log('‚úÖ Autenticado con Google Drive');
                            resolve(accessToken);
                        } else {
                            reject(new Error('No se pudo obtener token de acceso'));
                        }
                    },
                });
                client.requestAccessToken();
            });
        }
        
        // Buscar carpeta por nombre dentro de una carpeta padre
        async function findFolder(folderName, parentFolderId) {
            console.log(`üîç Buscando carpeta: ${folderName}`);
            
            const query = `name='${folderName}' and '${parentFolderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`;
            
            const response = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name)`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });
            
            if (!response.ok) {
                throw new Error('Error al buscar carpeta');
            }
            
            const result = await response.json();
            return result.files && result.files.length > 0 ? result.files[0].id : null;
        }
        
        // Crear carpeta en Google Drive
        async function createFolder(folderName, parentFolderId) {
            console.log(`üìÅ Creando carpeta: ${folderName}`);
            
            const metadata = {
                name: folderName,
                mimeType: 'application/vnd.google-apps.folder',
                parents: [parentFolderId]
            };
            
            const response = await fetch('https://www.googleapis.com/drive/v3/files?fields=id,name', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(metadata)
            });
            
            if (!response.ok) {
                throw new Error('Error al crear carpeta');
            }
            
            const result = await response.json();
            console.log(`‚úÖ Carpeta creada: ${result.name} (${result.id})`);
            return result.id;
        }
        
        // Obtener o crear carpeta (si no existe, la crea)
        async function getOrCreateFolder(folderName, parentFolderId) {
            let folderId = await findFolder(folderName, parentFolderId);
            
            if (!folderId) {
                folderId = await createFolder(folderName, parentFolderId);
            } else {
                console.log(`‚úÖ Carpeta encontrada: ${folderName}`);
            }
            
            return folderId;
        }
        
        // Subir archivo a Google Drive con estructura de carpetas
        async function uploadToGoogleDrive(file, activityTitle, personName) {
            console.log(`üîµ Subiendo ${file.name} a Google Drive...`);
            
            if (!accessToken) {
                await authenticateGoogleDrive();
            }
            
            // Crear estructura: Carpeta Principal / Nombre Persona / Actividad
            const personFolderId = await getOrCreateFolder(personName, GOOGLE_DRIVE_FOLDER_ID);
            const activityFolderId = await getOrCreateFolder(activityTitle, personFolderId);
            
            const metadata = {
                name: file.name,
                parents: [activityFolderId],
                description: `Entregado por: ${personName} para ${activityTitle}`
            };
            
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);
            
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink,webContentLink', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                },
                body: form
            });
            
            if (!response.ok) {
                const error = await response.text();
                throw new Error(`Error al subir a Drive: ${error}`);
            }
            
            const result = await response.json();
            console.log(`‚úÖ Archivo subido: ${result.name}`);
            
            return {
                name: file.name,
                driveId: result.id,
                url: result.webViewLink,
                downloadUrl: result.webContentLink,
                size: file.size,
                personFolder: personName,
                activityFolder: activityTitle
            };
        }
        
        const teamMembers = ['Juan Pablo Salazar', 'Efren Mendoza', 'Laura Nayeli', 'Donaji Buenrostro', 'Marco Carrasco'];

        let activities = [];
        let showForm = false, showModal = false, showDeleteModal = false, showMemberStats = false;
        let currentActivity = null, activityToDelete = null, deletePassword = '';
        let selectedFiles = [], searchTerm = '', filterMember = '', filterStatus = '';
        let formData = { creator: '', title: '', description: '', deadline: '', requiresSubmission: false };
        let submissionData = { name: '', comments: '' };

        async function loadActivities() {
            console.log('üîµ Cargando actividades...');
            try {
                console.log('üîµ Verificando conexi√≥n a Firestore...');
                const testSnapshot = await getDocs(collection(db, 'activities'));
                console.log(`‚úÖ Conexi√≥n exitosa. Documentos: ${testSnapshot.size}`);
                
                console.log('üîµ Configurando listener en tiempo real...');
                const q = query(collection(db, 'activities'), orderBy('createdAt', 'desc'));
                
                onSnapshot(q, 
                    (snapshot) => {
                        console.log(`‚úÖ Recibidos ${snapshot.size} documentos`);
                        activities = [];
                        snapshot.forEach((docSnap) => {
                            activities.push({ firebaseId: docSnap.id, ...docSnap.data() });
                        });
                        console.log('‚úÖ Actividades procesadas:', activities.length);
                        render();
                        document.getElementById('loadingScreen').classList.add('hidden');
                    },
                    (error) => {
                        console.error('‚ùå Error en listener:', error);
                        document.getElementById('loadingScreen').innerHTML = `
                            <div class="text-center max-w-2xl mx-auto p-6">
                                <div class="text-red-600 text-6xl mb-4">‚ö†Ô∏è</div>
                                <h2 class="text-xl font-bold mb-2">Error de Firestore</h2>
                                <p class="text-gray-700 mb-2">${error.message}</p>
                                <button onclick="location.reload()" class="bg-blue-600 text-white px-6 py-2 rounded-lg">Reintentar</button>
                            </div>
                        `;
                    }
                );
            } catch (error) {
                console.error('‚ùå Error al cargar:', error);
                document.getElementById('loadingScreen').innerHTML = `
                    <div class="text-center max-w-2xl mx-auto p-6">
                        <div class="text-red-600 text-6xl mb-4">‚ö†Ô∏è</div>
                        <h2 class="text-xl font-bold mb-2">Error al Cargar</h2>
                        <p class="text-gray-700 mb-4">${error.message}</p>
                        <button onclick="location.reload()" class="bg-blue-600 text-white px-6 py-2 rounded-lg">Reintentar</button>
                    </div>
                `;
            }
        }

        async function createActivity() {
            if (!formData.creator || !formData.title || !formData.description || !formData.deadline) {
                alert('Completa todos los campos'); return;
            }
            await addDoc(collection(db, 'activities'), { ...formData, submissions: [], createdAt: new Date().toISOString() });
            showForm = false;
            formData = { creator: '', title: '', description: '', deadline: '', requiresSubmission: false };
            alert('Actividad creada'); render();
        }

        async function deleteActivity() {
            if (deletePassword === 'Confirmareliminar00') {
                await deleteDoc(doc(db, 'activities', activityToDelete));
                showDeleteModal = false; activityToDelete = null; deletePassword = '';
                alert('Eliminada'); render();
            } else { alert('Contrase√±a incorrecta'); deletePassword = ''; render(); }
        }

        async function submitDelivery() {
            console.log('üîµ Intentando subir entrega...');
            console.log('Nombre:', submissionData.name);
            console.log('Archivos seleccionados:', selectedFiles.length);
            
            if (!submissionData.name.trim()) {
                alert('Por favor selecciona tu nombre'); 
                return;
            }
            if (selectedFiles.length === 0) {
                alert('Por favor selecciona al menos un archivo'); 
                return;
            }
            
            if (GOOGLE_CLIENT_ID.includes('TU_CLIENT_ID')) {
                alert('‚ö†Ô∏è Google Drive no est√° configurado.\n\nEdita el archivo HTML y agrega:\n- Tu Client ID de Google\n- Tu Folder ID de Drive\n\nVe el archivo CONFIGURACION_GOOGLE_DRIVE.md');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            
            try {
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<div class="flex items-center justify-center gap-2"><div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div><span>Subiendo a Drive...</span></div>';
                }
                
                console.log('üîµ Subiendo archivos a Google Drive...');
                const submissionId = Date.now().toString();
                const personName = submissionData.name.trim();
                
                const uploadedFiles = [];
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    console.log(`  üì§ Subiendo ${i + 1}/${selectedFiles.length}: ${file.name}...`);
                    try {
                        const uploadedFile = await uploadToGoogleDrive(file, currentActivity.title, personName);
                        uploadedFiles.push(uploadedFile);
                        console.log(`  ‚úÖ Subido: ${file.name}`);
                    } catch (uploadError) {
                        console.error(`  ‚ùå Error subiendo ${file.name}:`, uploadError);
                        throw new Error(`Error al subir ${file.name}: ${uploadError.message}`);
                    }
                }
                console.log('‚úÖ Todos los archivos subidos a Drive');
                
                console.log('üîµ Actualizando Firestore...');
                const submission = { 
                    id: submissionId, 
                    name: submissionData.name.trim(), 
                    comments: submissionData.comments.trim(), 
                    files: uploadedFiles, 
                    date: new Date().toISOString() 
                };
                
                await updateDoc(doc(db, 'activities', currentActivity.firebaseId), { 
                    submissions: [...currentActivity.submissions, submission] 
                });
                console.log('‚úÖ Firestore actualizado exitosamente');
                
                submissionData = { name: '', comments: '' }; 
                selectedFiles = [];
                showModal = false;
                currentActivity = null;
                
                alert('‚úÖ Entrega registrada correctamente en Google Drive');
                render();
            } catch (error) {
                console.error('‚ùå Error al subir entrega:', error);
                console.error('Stack trace:', error.stack);
                
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Subir';
                }
                
                alert(`‚ùå Error al subir entrega:\n${error.message}\n\nRevisa la consola para m√°s detalles.`);
            }
        }

        function handleFileSelect(e) {
            console.log('üîµ Archivos seleccionados:', e.target.files.length);
            Array.from(e.target.files).forEach(f => {
                console.log(`  Archivo: ${f.name}, Tama√±o: ${(f.size / 1024 / 1024).toFixed(2)} MB`);
                if (f.size > 10 * 1024 * 1024) {
                    console.log(`  ‚ùå Archivo muy grande: ${f.name}`);
                    alert(`${f.name} es muy grande (m√°x 10MB)`);
                } else {
                    console.log(`  ‚úÖ Archivo agregado: ${f.name}`);
                    selectedFiles.push(f);
                }
            });
            console.log(`üìã Total de archivos en lista: ${selectedFiles.length}`);
            updateFileList();
        }
        
        function updateFileList() {
            const fileListContainer = document.getElementById('fileListContainer');
            if (fileListContainer) {
                if (selectedFiles.length > 0) {
                    fileListContainer.innerHTML = `<div class="space-y-1 max-h-32 overflow-y-auto">${selectedFiles.map((f, i) => `<div class="flex justify-between bg-gray-50 p-2 rounded text-xs"><span class="truncate">${f.name}</span><button onclick="window.removeFileAt(${i})" class="text-red-600 ml-2">‚úï</button></div>`).join('')}</div>`;
                } else {
                    fileListContainer.innerHTML = '';
                }
            }
        }

        function getFilteredActivities() {
            return activities.filter(a => {
                const matchSearch = !searchTerm || a.title.toLowerCase().includes(searchTerm.toLowerCase()) || a.description.toLowerCase().includes(searchTerm.toLowerCase());
                const matchMember = !filterMember || a.creator === filterMember;
                const matchStatus = !filterStatus || (filterStatus === 'activa' ? new Date(a.deadline) >= new Date() : new Date(a.deadline) < new Date());
                return matchSearch && matchMember && matchStatus;
            });
        }

        function getMemberStats() {
            return teamMembers.map(member => {
                const created = activities.filter(a => a.creator === member).length;
                const submissions = activities.reduce((sum, act) => sum + act.submissions.filter(s => s.name === member).length, 0);
                const totalFiles = activities.reduce((sum, act) => sum + act.submissions.filter(s => s.name === member).reduce((fs, s) => fs + s.files.length, 0), 0);
                const submissionDetails = activities.map(act => ({ activity: act.title, submissions: act.submissions.filter(s => s.name === member) })).filter(i => i.submissions.length > 0);
                return { name: member, created, submissions, totalFiles, submissionDetails };
            });
        }

        function render() {
            const stats = {
                total: activities.length,
                expired: activities.filter(a => new Date(a.deadline) < new Date()).length,
                active: activities.filter(a => new Date(a.deadline) >= new Date()).length,
                submissions: activities.reduce((sum, a) => sum + a.submissions.length, 0)
            };
            const filtered = getFilteredActivities();

            document.getElementById('app').innerHTML = `
                <div class="bg-gradient-to-r from-blue-800 to-blue-900 text-white py-6">
                    <div class="max-w-7xl mx-auto px-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <h1 class="text-3xl font-bold">Sistema de Seguimiento</h1>
                                <p class="text-blue-200">SDHyBC - Archivos en Google Drive</p>
                            </div>
                            ${!isGoogleDriveReady ? '<button onclick="window.authenticateDrive()" class="bg-white text-blue-800 px-4 py-2 rounded-lg font-bold">üîê Conectar Google Drive</button>' : '<span class="text-green-300">‚úÖ Drive conectado</span>'}
                        </div>
                    </div>
                </div>
                <div class="max-w-7xl mx-auto px-4 py-8">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-blue-600"><p class="text-xs text-gray-600">Total</p><p class="text-2xl font-bold">${stats.total}</p></div>
                        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-red-500"><p class="text-xs text-gray-600">Vencidas</p><p class="text-2xl font-bold text-red-700">${stats.expired}</p></div>
                        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-yellow-500"><p class="text-xs text-gray-600">Activas</p><p class="text-2xl font-bold text-yellow-700">${stats.active}</p></div>
                        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-green-500"><p class="text-xs text-gray-600">Entregas</p><p class="text-2xl font-bold text-green-700">${stats.submissions}</p></div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <div class="flex flex-col gap-4">
                            <div class="flex gap-4"><input type="text" id="searchInput" placeholder="Buscar..." value="${searchTerm}" class="flex-1 px-4 py-2 border rounded-lg"><button onclick="window.toggleForm()" class="bg-blue-600 text-white px-6 py-2 rounded-lg">+ Crear</button><button onclick="window.toggleStats()" class="bg-green-600 text-white px-6 py-2 rounded-lg">${showMemberStats ? 'Actividades' : 'Seguimiento'}</button></div>
                            <div class="grid grid-cols-2 gap-4">
                                <select id="filterMember" class="px-4 py-2 border rounded-lg"><option value="">Todos</option>${teamMembers.map(m => `<option value="${m}" ${filterMember === m ? 'selected' : ''}>${m}</option>`).join('')}</select>
                                <select id="filterStatus" class="px-4 py-2 border rounded-lg"><option value="">Todos</option><option value="activa" ${filterStatus === 'activa' ? 'selected' : ''}>Activas</option><option value="vencida" ${filterStatus === 'vencida' ? 'selected' : ''}>Vencidas</option></select>
                            </div>
                        </div>
                    </div>
                    ${showForm ? `<div class="bg-white rounded-lg shadow p-6 mb-6"><h2 class="text-xl font-bold mb-4">Nueva Actividad</h2><div class="space-y-4"><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm mb-2">Nombre *</label><select id="creator" class="w-full px-4 py-2 border rounded-lg"><option value="">Selecciona</option>${teamMembers.map(m => `<option value="${m}">${m}</option>`).join('')}</select></div><div><label class="block text-sm mb-2">L√≠mite *</label><input type="datetime-local" id="deadline" class="w-full px-4 py-2 border rounded-lg"></div></div><div><label class="block text-sm mb-2">T√≠tulo *</label><input type="text" id="title" class="w-full px-4 py-2 border rounded-lg"></div><div><label class="block text-sm mb-2">Descripci√≥n *</label><textarea id="description" rows="4" class="w-full px-4 py-2 border rounded-lg"></textarea></div><label class="flex items-center gap-2"><input type="checkbox" id="requiresSubmission">Requiere entregas</label><div class="flex gap-3"><button onclick="window.saveActivity()" class="bg-blue-600 text-white px-6 py-2 rounded-lg">Crear</button><button onclick="window.toggleForm()" class="bg-gray-200 px-6 py-2 rounded-lg">Cancelar</button></div></div></div>` : ''}
                    ${showMemberStats ? `<div class="space-y-4">${getMemberStats().map(m => `<div class="bg-white rounded-lg shadow p-6"><h3 class="text-xl font-bold">${m.name}</h3><div class="flex gap-4 text-sm text-gray-600 my-2"><span>Creadas: ${m.created}</span><span>Entregas: ${m.submissions}</span><span>Archivos: ${m.totalFiles}</span></div>${m.submissionDetails.length > 0 ? `<div class="border-t pt-4">${m.submissionDetails.map(d => `<div class="bg-gray-50 rounded p-3 mb-2"><p class="font-medium">${d.activity}</p>${d.submissions.map(s => `<div class="ml-4 text-sm text-gray-600 mt-1"><p>Fecha: ${new Date(s.date).toLocaleDateString('es-MX')}</p>${s.comments ? `<p>Comentario: ${s.comments}</p>` : ''}<p>Archivos: ${s.files.map(f => f.name).join(', ')}</p></div>`).join('')}</div>`).join('')}</div>` : '<p class="text-gray-500 text-sm pt-4 border-t">Sin entregas</p>'}</div>`).join('')}</div>` : `<div class="space-y-4">${filtered.length === 0 ? '<div class="bg-white rounded-lg shadow p-12 text-center"><p class="text-gray-500">No hay actividades</p></div>' : filtered.map(act => {
                        const isExpired = new Date(act.deadline) < new Date();
                        return `<div class="bg-white rounded-lg shadow p-6"><div class="flex justify-between items-start mb-3"><div class="flex gap-3"><span class="px-3 py-1 rounded-full text-xs font-bold ${isExpired ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${isExpired ? 'VENCIDA' : 'ACTIVA'}</span>${act.requiresSubmission ? '<span class="px-3 py-1 rounded-full text-xs bg-blue-100 text-blue-800">Requiere entregas</span>' : ''}</div><button onclick="window.openDeleteModal('${act.firebaseId}')" class="text-red-600 hover:bg-red-50 p-2 rounded">üóëÔ∏è</button></div><h3 class="text-xl font-bold mb-2">${act.title}</h3><p class="text-gray-600 mb-3">${act.description}</p><div class="text-sm text-gray-600 mb-3"><p><strong>Creador:</strong> ${act.creator}</p><p><strong>L√≠mite:</strong> ${new Date(act.deadline).toLocaleString('es-MX')}</p>${act.requiresSubmission ? `<p><strong>Entregas:</strong> ${act.submissions.length}</p>` : ''}</div>${act.requiresSubmission ? `<button onclick="window.openSubmissionModal('${act.firebaseId}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">Ver/Subir</button>` : ''}</div>`;
                    }).join('')}</div>`}
                </div>
                ${showModal && currentActivity ? `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto"><div class="flex justify-between mb-4"><div class="flex-1 pr-4"><h3 class="text-xl font-bold">${currentActivity.title}</h3><p class="text-sm text-gray-600 mt-1">${currentActivity.description}</p><p class="text-xs text-gray-500 mt-1">L√≠mite: ${new Date(currentActivity.deadline).toLocaleString('es-MX')}</p></div><button onclick="window.closeModal()" class="text-gray-400">‚úï</button></div><div class="border-t pt-4 mb-4"><h4 class="font-bold mb-3">Subir Entrega a Google Drive</h4><div class="space-y-3"><select id="subName" class="w-full px-3 py-2 text-sm border rounded-lg"><option value="">Selecciona</option>${teamMembers.map(m => `<option value="${m}">${m}</option>`).join('')}</select><textarea id="subComments" rows="2" placeholder="Comentarios..." class="w-full px-3 py-2 text-sm border rounded-lg"></textarea><div class="border-2 border-dashed rounded-lg p-4 text-center cursor-pointer hover:border-blue-500" onclick="document.getElementById('fileInput').click()"><p class="text-xs">üìÅ Clic para seleccionar archivos (m√°x 10MB c/u)</p></div><input type="file" id="fileInput" multiple class="hidden"><div id="fileListContainer">${selectedFiles.length > 0 ? `<div class="space-y-1 max-h-32 overflow-y-auto">${selectedFiles.map((f, i) => `<div class="flex justify-between bg-gray-50 p-2 rounded text-xs"><span class="truncate">${f.name}</span><button onclick="window.removeFileAt(${i})" class="text-red-600 ml-2">‚úï</button></div>`).join('')}</div>` : ''}</div><button id="submitBtn" onclick="window.uploadSubmission()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">üì§ Subir a Drive</button></div></div><div class="border-t pt-4"><h4 class="font-bold mb-3">Entregas (${currentActivity.submissions.length})</h4>${currentActivity.submissions.length === 0 ? '<p class="text-center text-gray-500 py-4 text-sm">Sin entregas</p>' : `<div class="space-y-3 max-h-64 overflow-y-auto">${currentActivity.submissions.map(s => `<div class="border rounded-lg p-3 bg-gray-50"><p class="font-bold text-sm">${s.name}</p><p class="text-xs text-gray-500">${new Date(s.date).toLocaleString('es-MX')}</p>${s.comments ? `<p class="text-xs text-gray-700 mt-1">${s.comments}</p>` : ''}<div class="mt-2 space-y-1">${s.files.map(f => `<a href="${f.url}" target="_blank" class="flex items-center gap-2 text-xs text-blue-600 hover:bg-blue-100 px-2 py-1 rounded">üìé <span class="truncate">${f.name}</span></a>`).join('')}</div></div>`).join('')}</div>`}</div></div></div>` : ''}
                ${showDeleteModal ? `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"><div class="bg-white rounded-lg p-6 max-w-md w-full"><h3 class="text-xl font-bold mb-4">Eliminar</h3><p class="text-gray-600 mb-4">Contrase√±a:</p><input type="password" id="delPassword" class="w-full px-4 py-2 border rounded-lg mb-4"><div class="flex gap-3"><button onclick="window.confirmDelete()" class="flex-1 bg-red-600 text-white px-6 py-2 rounded-lg">Eliminar</button><button onclick="window.closeDeleteModal()" class="flex-1 bg-gray-200 px-6 py-2 rounded-lg">Cancelar</button></div></div></div>` : ''}
            `;
            document.getElementById('searchInput')?.addEventListener('input', (e) => { searchTerm = e.target.value; render(); });
            document.getElementById('filterMember')?.addEventListener('change', (e) => { filterMember = e.target.value; render(); });
            document.getElementById('filterStatus')?.addEventListener('change', (e) => { filterStatus = e.target.value; render(); });
            document.getElementById('fileInput')?.addEventListener('change', handleFileSelect);
        }

        window.toggleForm = () => { showForm = !showForm; render(); };
        window.toggleStats = () => { showMemberStats = !showMemberStats; render(); };
        window.saveActivity = () => { formData = { creator: document.getElementById('creator').value, title: document.getElementById('title').value, description: document.getElementById('description').value, deadline: document.getElementById('deadline').value, requiresSubmission: document.getElementById('requiresSubmission').checked }; createActivity(); };
        window.openSubmissionModal = (id) => { currentActivity = activities.find(a => a.firebaseId === id); showModal = true; selectedFiles = []; submissionData = { name: '', comments: '' }; render(); };
        window.closeModal = () => { showModal = false; currentActivity = null; selectedFiles = []; render(); };
        window.uploadSubmission = async () => { 
            try {
                submissionData = { 
                    name: document.getElementById('subName').value, 
                    comments: document.getElementById('subComments').value 
                }; 
                await submitDelivery(); 
            } catch (error) {
                console.error('‚ùå Error en uploadSubmission:', error);
                alert(`Error: ${error.message}`);
            }
        };
        window.removeFileAt = (i) => { 
            selectedFiles.splice(i, 1); 
            console.log(`üóëÔ∏è Archivo eliminado. Restantes: ${selectedFiles.length}`);
            updateFileList(); 
        };
        window.openDeleteModal = (id) => { activityToDelete = id; showDeleteModal = true; deletePassword = ''; render(); };
        window.closeDeleteModal = () => { showDeleteModal = false; activityToDelete = null; deletePassword = ''; render(); };
        window.confirmDelete = () => { deletePassword = document.getElementById('delPassword').value; deleteActivity(); };
        window.authenticateDrive = async () => {
            try {
                await authenticateGoogleDrive();
                alert('‚úÖ Conectado con Google Drive');
                render();
            } catch (error) {
                alert(`Error al conectar: ${error.message}`);
            }
        };
        
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { if (showModal) window.closeModal(); if (showDeleteModal) window.closeDeleteModal(); } });
        
        setTimeout(() => {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen && !loadingScreen.classList.contains('hidden')) {
                loadingScreen.classList.add('hidden');
                alert('El sistema tard√≥ en cargar. Si no ves actividades, recarga la p√°gina.');
            }
        }, 10000);
        
        // Inicializar Google Drive cuando cargue la p√°gina
        window.addEventListener('load', () => {
            setTimeout(initGoogleDrive, 1000);
        });
        
        console.log('üîµ Llamando a loadActivities...');
        loadActivities();
    </script>
</body>
</html>

